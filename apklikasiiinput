<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Input Data Pengiriman & Penerimaan</title>
    
    <!-- Memuat Tailwind CSS untuk styling modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Google Fonts (Inter) untuk tipografi yang lebih baik -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Memuat Tone.js untuk notifikasi suara -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }
        .tab-btn.active { background-color: #3b82f6; color: white; }
        .tab-btn:not(.active) { background-color: #475569; color: #cbd5e1; }
        /* Style untuk scrollbar di tabel */
        .table-container::-webkit-scrollbar { width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #1e293b; }
        .table-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 p-4 md:p-8">

    <!-- Kontainer utama -->
    <div class="w-full max-w-6xl mx-auto">

        <!-- Dashboard Ringkasan -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-4">Dashboard Hari Ini</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Card Total Kirim -->
                <div class="bg-slate-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                    <div class="bg-blue-500 p-3 rounded-full">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0l3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Total Kirim (Hari Ini)</p>
                        <p id="summary-kirim" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>
                <!-- Card Total Terima -->
                <div class="bg-slate-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                     <div class="bg-green-500 p-3 rounded-full">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13l-3 3m0 0l-3-3m3 3V8m0 13a9 9 0 110 18 9 9 0 010-18z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Total Terima (Hari Ini)</p>
                        <p id="summary-terima" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>
                <!-- Card Pengiriman Tertunda -->
                <div class="bg-slate-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                     <div class="bg-red-500 p-3 rounded-full">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Pengiriman Tertunda</p>
                        <p id="summary-tertunda" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kontainer Form -->
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl mb-8">
            
            <!-- Tombol Pilihan Mode (Switcher) -->
            <div class="flex border border-slate-600 rounded-lg mb-8">
                <button id="show-kirim-form" class="tab-btn w-1/2 p-3 rounded-l-md font-semibold transition-colors duration-300 active">Kirim Barang</button>
                <button id="show-terima-form" class="tab-btn w-1/2 p-3 rounded-r-md font-semibold transition-colors duration-300">Terima Barang</button>
            </div>

            <!-- Kontainer untuk Form Kirim -->
            <div id="form-kirim-container">
                <div class="text-center mb-8"><h1 class="text-3xl font-bold text-white">Input Data Pengiriman</h1><p class="text-slate-400 mt-2">Isi semua kolom pengiriman di bawah ini.</p></div>
                <form name="form-kirim" id="form-kirim" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div><label for="tanggal-kirim" class="block mb-2 text-sm font-medium text-slate-300">Tanggal</label><input type="date" id="tanggal-kirim" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                        <div><label for="no_bpb-kirim" class="block mb-2 text-sm font-medium text-slate-300">No. BPB</label><input type="text" id="no_bpb-kirim" placeholder="Contoh: BPB/2024/VII/001" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div><label for="tujuan-kirim" class="block mb-2 text-sm font-medium text-slate-300">Tujuan</label><input type="text" id="tujuan-kirim" placeholder="Contoh: Gudang Pusat Jakarta" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                        <div><label for="pengirim-kirim" class="block mb-2 text-sm font-medium text-slate-300">Nama Pengirim</label><input type="text" id="pengirim-kirim" placeholder="Nama Lengkap Pengirim" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                    </div>
                    <hr class="border-slate-600">
                    <div class="space-y-4" id="items-container-kirim"><div class="item-row grid grid-cols-12 gap-4 items-end"><div class="col-span-7"><label class="block mb-2 text-sm font-medium text-slate-300">Kode Barang</label><input type="text" name="Kode Barang" placeholder="Contoh: BRG-XYZ-001" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div><div class="col-span-3"><label class="block mb-2 text-sm font-medium text-slate-300">Jumlah</label><input type="number" name="Jumlah" placeholder="Jml" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required min="1"></div></div></div>
                    <button type="button" id="add-item-btn-kirim" class="w-full text-blue-400 bg-slate-700 hover:bg-slate-600 focus:ring-4 focus:outline-none focus:ring-slate-500 font-semibold rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300 flex items-center justify-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Tambah Barang</button>
                    <hr class="border-slate-600">
                    <button type="submit" class="submit-button w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-semibold rounded-lg text-md px-5 py-3 text-center transition-colors duration-300 flex items-center justify-center">Kirim Semua Data</button>
                </form>
            </div>

            <!-- Kontainer untuk Form Terima -->
            <div id="form-terima-container" class="hidden">
                <div class="text-center mb-8"><h1 class="text-3xl font-bold text-white">Input Data Penerimaan</h1><p class="text-slate-400 mt-2">Isi semua kolom penerimaan di bawah ini.</p></div>
                <form name="form-terima" id="form-terima" class="space-y-6">
                     <div class="grid md:grid-cols-2 gap-6">
                        <div><label for="tanggal-terima" class="block mb-2 text-sm font-medium text-slate-300">Tanggal</label><input type="date" id="tanggal-terima" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                        <div><label for="no_bpb-terima" class="block mb-2 text-sm font-medium text-slate-300">No. BPB</label><input type="text" id="no_bpb-terima" placeholder="Contoh: BPB/2024/VII/001" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div><label for="tujuan-terima" class="block mb-2 text-sm font-medium text-slate-300">Tujuan</label><input type="text" id="tujuan-terima" placeholder="Contoh: Gudang Asal Pengirim" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                        <div><label for="penerima-terima" class="block mb-2 text-sm font-medium text-slate-300">Nama Penerima</label><input type="text" id="penerima-terima" placeholder="Nama Lengkap Penerima" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                    </div>
                    <hr class="border-slate-600">
                    <div class="space-y-4" id="items-container-terima"><div class="item-row grid grid-cols-12 gap-4 items-end"><div class="col-span-7"><label class="block mb-2 text-sm font-medium text-slate-300">Kode Barang</label><input type="text" name="Kode Barang" placeholder="Contoh: BRG-XYZ-001" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div><div class="col-span-3"><label class="block mb-2 text-sm font-medium text-slate-300">Jumlah</label><input type="number" name="Jumlah" placeholder="Jml" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required min="1"></div></div></div>
                    <button type="button" id="add-item-btn-terima" class="w-full text-blue-400 bg-slate-700 hover:bg-slate-600 focus:ring-4 focus:outline-none focus:ring-slate-500 font-semibold rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300 flex items-center justify-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Tambah Barang</button>
                    <hr class="border-slate-600">
                    <button type="submit" class="submit-button w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-semibold rounded-lg text-md px-5 py-3 text-center transition-colors duration-300 flex items-center justify-center">Terima Semua Data</button>
                </form>
            </div>
            <!-- Pesan Status Global -->
            <div id="status-message" class="mt-6 text-center text-sm font-medium h-5"></div>
        </div>

        <!-- Kontainer Tabel Data -->
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Tabel Data Pengiriman -->
            <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-xl font-bold text-white">Data Pengiriman</h2>
                        <div class="flex border border-slate-600 rounded-lg text-sm">
                           <button id="kirim-today-btn" class="tab-btn px-3 py-1 rounded-l-md font-semibold transition-colors duration-300 active">Hari Ini</button>
                           <button id="kirim-all-btn" class="tab-btn px-3 py-1 rounded-r-md font-semibold transition-colors duration-300">Semua</button>
                        </div>
                    </div>
                    <button id="refresh-kirim-btn" title="Muat Ulang Data" class="text-slate-400 hover:text-white transition-colors p-1 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"></path><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path></svg>
                    </button>
                </div>
                 <div class="mb-4">
                    <input type="text" id="search-kirim" placeholder="Cari No. BPB, Kode Barang, Pengirim..." class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div class="table-container overflow-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-300 uppercase bg-slate-700 sticky top-0">
                            <tr>
                                <th scope="col" class="px-4 py-3">Tanggal</th>
                                <th scope="col" class="px-4 py-3">Tujuan</th>
                                <th scope="col" class="px-4 py-3">No. BPB</th>
                                <th scope="col" class="px-4 py-3">Pengirim</th>
                                <th scope="col" class="px-4 py-3">Kode Barang</th>
                                <th scope="col" class="px-4 py-3 text-right">Jumlah</th>
                                <th scope="col" class="px-4 py-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-kirim"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tabel Data Penerimaan -->
            <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl">
                 <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-xl font-bold text-white">Data Penerimaan</h2>
                        <div class="flex border border-slate-600 rounded-lg text-sm">
                           <button id="terima-today-btn" class="tab-btn px-3 py-1 rounded-l-md font-semibold transition-colors duration-300 active">Hari Ini</button>
                           <button id="terima-all-btn" class="tab-btn px-3 py-1 rounded-r-md font-semibold transition-colors duration-300">Semua</button>
                        </div>
                    </div>
                    <button id="refresh-terima-btn" title="Muat Ulang Data" class="text-slate-400 hover:text-white transition-colors p-1 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"></path><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path></svg>
                    </button>
                </div>
                 <div class="mb-4">
                    <input type="text" id="search-terima" placeholder="Cari No. BPB, Kode Barang, Penerima..." class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div class="table-container overflow-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-300 uppercase bg-slate-700 sticky top-0">
                             <tr>
                                <th scope="col" class="px-4 py-3">Tanggal</th>
                                <th scope="col" class="px-4 py-3">Tujuan</th>
                                <th scope="col" class="px-4 py-3">No. BPB</th>
                                <th scope="col" class="px-4 py-3">Penerima</th>
                                <th scope="col" class="px-4 py-3">Kode Barang</th>
                                <th scope="col" class="px-4 py-3 text-right">Jumlah</th>
                                <th scope="col" class="px-4 py-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-terima"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Kontainer Tabel Rekapan -->
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Rekapan Selisih</h2>
                 <button id="refresh-recap-btn" title="Buat Ulang Rekapan" class="text-slate-400 hover:text-white transition-colors p-1 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"></path><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path></svg>
                </button>
            </div>
            <div class="table-container overflow-auto max-h-96">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-300 uppercase bg-slate-700 sticky top-0">
                         <tr>
                            <th scope="col" class="px-4 py-3">Tanggal Kirim</th>
                            <th scope="col" class="px-4 py-3">No. BPB</th>
                            <th scope="col" class="px-4 py-3">Kode Barang</th>
                            <th scope="col" class="px-4 py-3 text-center">Jml Kirim</th>
                            <th scope="col" class="px-4 py-3 text-center">Jml Terima</th>
                            <th scope="col" class="px-4 py-3 text-center">Selisih</th>
                        </tr>
                    </thead>
                    <tbody id="table-body-recap"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-sm shadow-xl">
            <h3 class="text-lg font-bold text-white mb-4">Konfirmasi Hapus</h3>
            <p id="modal-text" class="text-slate-300 mb-6">Anda yakin ingin menghapus baris ini secara permanen?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-5 py-2 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-lg transition-colors">Batal</button>
                <button id="modal-confirm-btn" class="px-5 py-2 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition-colors">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <script>
        // --- URL SPREADSHEET ---
        const scriptURLKirim = 'https://script.google.com/macros/s/AKfycbz0f10UaA2HhzJSuseRmRBkLdvw5MVES7MH-kg2IQ38W5tJflrk-72DTrAwa8zmgFlDiw/exec';
        const scriptURLTerima = 'https://script.google.com/macros/s/AKfycbxSwRZ5v2ulw4Y3NnOdtoAe3Jecy2xb2IBZHslOvMUpSaEFqSWcaLtaAGUl9So5Tg73/exec';

        // --- Elemen Global ---
        const statusMessage = document.getElementById('status-message');
        const showKirimBtn = document.getElementById('show-kirim-form');
        const showTerimaBtn = document.getElementById('show-terima-form');
        const formKirimContainer = document.getElementById('form-kirim-container');
        const formTerimaContainer = document.getElementById('form-terima-container');
        const deleteModal = document.getElementById('delete-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let deleteInfo = null;
        let dataKirim = [];
        let dataTerima = [];
        let kirimFilterIsDaily = true;
        let terimaFilterIsDaily = true;

        // --- Logika Pindah Form ---
        showKirimBtn.addEventListener('click', () => {
            formKirimContainer.classList.remove('hidden');
            formTerimaContainer.classList.add('hidden');
            showKirimBtn.classList.add('active');
            showTerimaBtn.classList.remove('active');
        });

        showTerimaBtn.addEventListener('click', () => {
            formKirimContainer.classList.add('hidden');
            formTerimaContainer.classList.remove('hidden');
            showKirimBtn.classList.remove('active');
            showTerimaBtn.classList.add('active');
        });

        // --- Fungsi Pengaturan Form (Tambah/Hapus Barang) ---
        const setupDynamicRows = (containerId, addButtonId) => {
            const itemsContainer = document.getElementById(containerId);
            const addItemBtn = document.getElementById(addButtonId);

            addItemBtn.addEventListener('click', () => {
                const itemRow = document.createElement('div');
                itemRow.className = 'item-row grid grid-cols-12 gap-4 items-end';
                itemRow.innerHTML = `<div class="col-span-7"><input type="text" name="Kode Barang" placeholder="Kode Barang" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div><div class="col-span-3"><input type="number" name="Jumlah" placeholder="Jml" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required min="1"></div><div class="col-span-2"><button type="button" class="remove-item-btn w-full h-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
                itemsContainer.appendChild(itemRow);
            });

            itemsContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-item-btn')) {
                    e.target.closest('.item-row').remove();
                }
            });
        };
        
        // --- Fungsi untuk Mengambil Data ---
        const fetchData = async (scriptURL, dataStore) => {
             try {
                const response = await fetch(scriptURL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (dataStore === 'kirim') dataKirim = data;
                if (dataStore === 'terima') dataTerima = data;
            } catch (error) {
                 console.error('Error fetching data for ' + dataStore, error);
                 if (dataStore === 'kirim') document.getElementById('table-body-kirim').innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-400">Gagal memuat data.<br><small>Pastikan Google Script di-deploy ulang.</small></td></tr>`;
                 if (dataStore === 'terima') document.getElementById('table-body-terima').innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-400">Gagal memuat data.<br><small>Pastikan Google Script di-deploy ulang.</small></td></tr>`;
            }
        };

        // --- Fungsi untuk Menampilkan Data & Status ---
        const renderTables = () => {
            const tableBodyKirim = document.getElementById('table-body-kirim');
            const tableBodyTerima = document.getElementById('table-body-terima');
            const searchTermKirim = document.getElementById('search-kirim').value.toLowerCase();
            const searchTermTerima = document.getElementById('search-terima').value.toLowerCase();
            
            // Render Tabel Kirim
            tableBodyKirim.innerHTML = '';
            let filteredDataKirim = kirimFilterIsDaily ? dataKirim.filter(row => row.Tanggal && new Date(row.Tanggal).toISOString().split('T')[0] === new Date().toISOString().split('T')[0]) : dataKirim;
            
            filteredDataKirim = filteredDataKirim.filter(row => {
                const noBpb = String(row['No BPB'] || '').toLowerCase();
                const kodeBarang = String(row['Kode Barang'] || '').toLowerCase();
                const pengirim = String(row['Nama Pengirim'] || '').toLowerCase();
                return noBpb.includes(searchTermKirim) || kodeBarang.includes(searchTermKirim) || pengirim.includes(searchTermKirim);
            });

            if (filteredDataKirim.length === 0) {
                 tableBodyKirim.innerHTML = `<tr><td colspan="8" class="text-center p-4">Tidak ada data untuk ditampilkan.</td></tr>`;
            } else {
                filteredDataKirim.slice().reverse().forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-slate-800 border-b border-slate-700 hover:bg-slate-600';
                    const formattedDate = new Date(row.Tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                    tr.innerHTML = `
                        <td class="px-4 py-3">${formattedDate}</td>
                        <td class="px-4 py-3">${row.Tujuan || ''}</td>
                        <td class="px-4 py-3">${String(row['No BPB'] || '')}</td>
                        <td class="px-4 py-3">${row['Nama Pengirim'] || ''}</td>
                        <td class="px-4 py-3">${String(row['Kode Barang'] || '')}</td>
                        <td class="px-4 py-3 text-right">${row.Jumlah || ''}</td>
                        <td class="px-4 py-3 text-center">
                            <button data-row-index="${row.rowIndex}" class="delete-btn text-red-400 hover:text-red-500 transition-colors">Hapus</button>
                        </td>
                    `;
                    tableBodyKirim.appendChild(tr);
                });
            }

            // Render Tabel Terima
            tableBodyTerima.innerHTML = '';
            let filteredDataTerima = terimaFilterIsDaily ? dataTerima.filter(row => row.Tanggal && new Date(row.Tanggal).toISOString().split('T')[0] === new Date().toISOString().split('T')[0]) : dataTerima;

            filteredDataTerima = filteredDataTerima.filter(row => {
                const noBpb = String(row['No BPB'] || '').toLowerCase();
                const kodeBarang = String(row['Kode Barang'] || '').toLowerCase();
                const penerima = String(row['Nama Penerima'] || '').toLowerCase();
                return noBpb.includes(searchTermTerima) || kodeBarang.includes(searchTermTerima) || penerima.includes(searchTermTerima);
            });

            if (filteredDataTerima.length === 0) {
                 tableBodyTerima.innerHTML = `<tr><td colspan="8" class="text-center p-4">Tidak ada data untuk ditampilkan.</td></tr>`;
            } else {
                filteredDataTerima.slice().reverse().forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-slate-800 border-b border-slate-700 hover:bg-slate-600';
                    const formattedDate = new Date(row.Tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                    tr.innerHTML = `
                        <td class="px-4 py-3">${formattedDate}</td>
                        <td class="px-4 py-3">${row.Tujuan || ''}</td>
                        <td class="px-4 py-3">${String(row['No BPB'] || '')}</td>
                        <td class="px-4 py-3">${row['Nama Penerima'] || ''}</td>
                        <td class="px-4 py-3">${String(row['Kode Barang'] || '')}</td>
                        <td class="px-4 py-3 text-right">${row.Jumlah || ''}</td>
                        <td class="px-4 py-3 text-center">
                            <button data-row-index="${row.rowIndex}" class="delete-btn text-red-400 hover:text-red-500 transition-colors">Hapus</button>
                        </td>
                    `;
                    tableBodyTerima.appendChild(tr);
                });
            }
        };

        // --- Fungsi untuk Membuat Rekapan ---
        const generateRecap = () => {
            const recapBody = document.getElementById('table-body-recap');
            recapBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">Membuat rekapan...</td></tr>`;

            let filteredDataKirimRecap = dataKirim;
            
            const kirimMap = new Map();
            filteredDataKirimRecap.forEach(row => {
                const noBpb = String(row['No BPB'] || row['no bpb'] || '');
                const kodeBarang = String(row['Kode Barang'] || row['kode barang'] || '');
                const key = `${noBpb.trim()}-${kodeBarang.trim()}`;
                const jumlah = parseInt(row.Jumlah || row.jumlah || 0);

                if (!kirimMap.has(key)) {
                    kirimMap.set(key, { total: 0, firstDate: row.Tanggal });
                }
                kirimMap.get(key).total += jumlah;
            });

            const terimaMap = new Map();
            dataTerima.forEach(row => {
                const noBpb = String(row['No BPB'] || row['no bpb'] || '');
                const kodeBarang = String(row['Kode Barang'] || row['kode barang'] || '');
                const key = `${noBpb.trim()}-${kodeBarang.trim()}`;
                const jumlah = parseInt(row.Jumlah || row.jumlah || 0);

                 if (!terimaMap.has(key)) {
                    terimaMap.set(key, 0);
                }
                terimaMap.set(key, terimaMap.get(key) + jumlah);
            });

            recapBody.innerHTML = '';
            let discrepancyFound = false;

            for (const [key, kirimData] of kirimMap.entries()) {
                const jumlahTerima = terimaMap.get(key) || 0;
                
                let shouldDisplay = false;
                let selisih = jumlahTerima - kirimData.total;
                let selisihText = selisih > 0 ? `+${selisih}` : selisih;
                let selisihClass = selisih < 0 ? 'text-red-400' : 'text-yellow-400';

                if (kirimData.total !== jumlahTerima) {
                    shouldDisplay = true;
                }

                if (!terimaMap.has(key) && kirimData.firstDate) {
                    const sentTime = new Date(kirimData.firstDate).getTime();
                    const currentTime = new Date().getTime();
                    const hoursDiff = (currentTime - sentTime) / (1000 * 60 * 60);

                    if (hoursDiff > 2) {
                        shouldDisplay = true;
                        selisihText += '<br><small class="text-xs">Belum Diterima (>2 Jam)</small>';
                    }
                }

                if (shouldDisplay) {
                    discrepancyFound = true;
                    
                    const [noBpb, kodeBarang] = key.split('-');
                    const eventDate = new Date(kirimData.firstDate);
                    const formattedDate = eventDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });

                    const tr = document.createElement('tr');
                    tr.className = 'bg-slate-800 border-b border-slate-700';
                    tr.innerHTML = `
                        <td class="px-4 py-3">${formattedDate}</td>
                        <td class="px-4 py-3">${noBpb}</td>
                        <td class="px-4 py-3">${kodeBarang}</td>
                        <td class="px-4 py-3 text-center">${kirimData.total}</td>
                        <td class="px-4 py-3 text-center">${jumlahTerima}</td>
                        <td class="px-4 py-3 text-center font-bold ${selisihClass}">${selisihText}</td>
                    `;
                    recapBody.appendChild(tr);
                }
            }

            if (!discrepancyFound) {
                recapBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">Tidak ditemukan selisih data.</td></tr>`;
            }
        };
        
        // --- Fungsi untuk Update Dashboard ---
        const updateDashboard = () => {
            const today = new Date().toISOString().split('T')[0];
            
            const todayKirim = dataKirim.filter(row => row.Tanggal && new Date(row.Tanggal).toISOString().split('T')[0] === today);
            const todayTerima = dataTerima.filter(row => row.Tanggal && new Date(row.Tanggal).toISOString().split('T')[0] === today);

            const totalKirim = todayKirim.reduce((sum, row) => sum + parseInt(row.Jumlah || 0), 0);
            const totalTerima = todayTerima.reduce((sum, row) => sum + parseInt(row.Jumlah || 0), 0);
            
            let tertundaCount = 0;
            const terimaMap = new Map();
            dataTerima.forEach(row => {
                const key = `${String(row['No BPB'] || '').trim()}-${String(row['Kode Barang'] || '').trim()}`;
                if (!terimaMap.has(key)) terimaMap.set(key, 0);
                terimaMap.set(key, terimaMap.get(key) + (parseInt(row.Jumlah || 0)));
            });

            todayKirim.forEach(row => {
                 const key = `${String(row['No BPB'] || '').trim()}-${String(row['Kode Barang'] || '').trim()}`;
                 if(!terimaMap.has(key)){
                     tertundaCount++;
                 }
            });

            document.getElementById('summary-kirim').textContent = totalKirim;
            document.getElementById('summary-terima').textContent = totalTerima;
            document.getElementById('summary-tertunda').textContent = tertundaCount;
        };

        // --- Fungsi untuk Memuat Semua Data ---
        const loadAllData = async () => {
            const kirimPromise = fetchData(scriptURLKirim, 'kirim');
            const terimaPromise = fetchData(scriptURLTerima, 'terima');
            await Promise.all([kirimPromise, terimaPromise]);
            renderTables();
            generateRecap();
            updateDashboard();
        };

        // --- Fungsi untuk Menghapus Baris ---
        const handleDeleteRow = async (scriptURL, rowIndex) => {
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowIndex', rowIndex);

            try {
                const response = await fetch(scriptURL, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.result !== 'success') throw new Error(result.error);
                
                statusMessage.textContent = 'Baris berhasil dihapus!';
                statusMessage.className = 'mt-6 text-center text-sm font-medium h-5 text-green-400';
                await loadAllData();
            } catch (error) {
                console.error('Error deleting row:', error);
                statusMessage.textContent = 'Gagal menghapus baris.';
                statusMessage.className = 'mt-6 text-center text-sm font-medium h-5 text-red-400';
            } finally {
                setTimeout(() => { statusMessage.textContent = ''; }, 3000);
            }
        };

        // --- Fungsi Pengiriman Data ---
        const handleFormSubmit = async (e, scriptURL) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('.submit-button');
            const itemsContainer = form.querySelector('.space-y-4');
            
            submitButton.disabled = true;
            submitButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Mengirim...`;
            statusMessage.textContent = '';

            const itemRows = itemsContainer.querySelectorAll('.item-row');
            const submissionPromises = [];

            itemRows.forEach(row => {
                const formData = new FormData();
                formData.append('action', 'submit');
                formData.append('Tanggal', form.querySelector('input[type="date"]').value);
                formData.append('No BPB', form.querySelector('input[id*="no_bpb"]').value);
                formData.append('Tujuan', form.querySelector('input[id*="tujuan"]').value);
                
                if (form.id === 'form-kirim') {
                    formData.append('Nama Pengirim', form.querySelector('input[id*="pengirim"]').value);
                } else {
                    formData.append('Nama Penerima', form.querySelector('input[id*="penerima"]').value);
                }

                formData.append('Kode Barang', row.querySelector('input[name="Kode Barang"]').value);
                formData.append('Jumlah', row.querySelector('input[name="Jumlah"]').value);
                submissionPromises.push(fetch(scriptURL, { method: 'POST', body: formData }));
            });

            try {
                await Promise.all(submissionPromises);
                new Tone.Synth().toDestination().triggerAttackRelease("C5", "8n");
                statusMessage.textContent = 'Semua data berhasil diproses!';
                statusMessage.className = 'mt-6 text-center text-sm font-medium h-5 text-green-400';
                form.reset();
                while (itemsContainer.children.length > 1) { itemsContainer.removeChild(itemsContainer.lastChild); }
                await loadAllData();
            } catch (error) {
                console.error('Error!', error.message);
                statusMessage.textContent = 'Sebagian/semua data berhasil dikirim (cek spreadsheet).';
                statusMessage.className = 'mt-6 text-center text-sm font-medium h-5 text-yellow-400';
                await loadAllData();
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = form.id === 'form-kirim' ? 'Kirim Semua Data' : 'Terima Semua Data';
                setTimeout(() => { statusMessage.textContent = ''; }, 5000);
            }
        };
        
        // --- Inisialisasi ---
        window.addEventListener('load', () => {
            setupDynamicRows('items-container-kirim', 'add-item-btn-kirim');
            setupDynamicRows('items-container-terima', 'add-item-btn-terima');
            
            document.getElementById('form-kirim').addEventListener('submit', (e) => handleFormSubmit(e, scriptURLKirim));
            document.getElementById('form-terima').addEventListener('submit', (e) => handleFormSubmit(e, scriptURLTerima));

            document.getElementById('table-body-kirim').addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) {
                    const rowIndex = e.target.closest('.delete-btn').dataset.rowIndex;
                    deleteInfo = { scriptURL: scriptURLKirim, rowIndex: rowIndex };
                    deleteModal.classList.remove('hidden');
                }
            });

            document.getElementById('table-body-terima').addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) {
                    const rowIndex = e.target.closest('.delete-btn').dataset.rowIndex;
                    deleteInfo = { scriptURL: scriptURLTerima, rowIndex: rowIndex };
                    deleteModal.classList.remove('hidden');
                }
            });

            modalConfirmBtn.addEventListener('click', () => {
                if (deleteInfo) {
                    handleDeleteRow(deleteInfo.scriptURL, deleteInfo.rowIndex);
                }
                deleteModal.classList.add('hidden');
                deleteInfo = null;
            });

            modalCancelBtn.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                deleteInfo = null;
            });

            // Refresh Buttons
            const refreshKirimBtn = document.getElementById('refresh-kirim-btn');
            const refreshTerimaBtn = document.getElementById('refresh-terima-btn');
            const refreshRecapBtn = document.getElementById('refresh-recap-btn');
            
            refreshKirimBtn.addEventListener('click', () => {
                const icon = refreshKirimBtn.querySelector('svg');
                icon.classList.add('animate-spin');
                loadAllData().finally(() => icon.classList.remove('animate-spin'));
            });

            refreshTerimaBtn.addEventListener('click', () => {
                const icon = refreshTerimaBtn.querySelector('svg');
                icon.classList.add('animate-spin');
                loadAllData().finally(() => icon.classList.remove('animate-spin'));
            });

            refreshRecapBtn.addEventListener('click', () => {
                const icon = refreshRecapBtn.querySelector('svg');
                icon.classList.add('animate-spin');
                loadAllData().finally(() => icon.classList.remove('animate-spin'));
            });

            // Filter Buttons
            const kirimTodayBtn = document.getElementById('kirim-today-btn');
            const kirimAllBtn = document.getElementById('kirim-all-btn');
            const terimaTodayBtn = document.getElementById('terima-today-btn');
            const terimaAllBtn = document.getElementById('terima-all-btn');

            kirimTodayBtn.addEventListener('click', () => {
                kirimFilterIsDaily = true;
                kirimTodayBtn.classList.add('active');
                kirimAllBtn.classList.remove('active');
                renderTables();
            });
            kirimAllBtn.addEventListener('click', () => {
                kirimFilterIsDaily = false;
                kirimTodayBtn.classList.remove('active');
                kirimAllBtn.classList.add('active');
                renderTables();
            });

            terimaTodayBtn.addEventListener('click', () => {
                terimaFilterIsDaily = true;
                terimaTodayBtn.classList.add('active');
                terimaAllBtn.classList.remove('active');
                renderTables();
            });
            terimaAllBtn.addEventListener('click', () => {
                terimaFilterIsDaily = false;
                terimaTodayBtn.classList.remove('active');
                terimaAllBtn.classList.add('active');
                renderTables();
            });

            // Search
            document.getElementById('search-kirim').addEventListener('input', renderTables);
            document.getElementById('search-terima').addEventListener('input', renderTables);

            loadAllData();
        });
    </script>
</body>
</html>
